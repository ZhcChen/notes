# Redis 备份与恢复

数据备份和恢复是任何生产系统的重要组成部分，Redis 也不例外。本节将介绍 Redis 的备份策略和恢复方法。

## 1. Redis 持久化机制

Redis 提供了两种主要的持久化机制，它们也是备份的基础：

*   **RDB (Redis Database)**:
    *   在指定的时间间隔内将内存中的数据集快照写入磁盘。
    *   生成一个紧凑的二进制文件 (`dump.rdb`)，非常适合用于备份和灾难恢复。
    *   优点：恢复速度快，文件紧凑。
    *   缺点：如果 Redis 意外停止，可能会丢失最后一次快照之后的数据。
*   **AOF (Append Only File)**:
    *   记录 Redis 服务器接收到的所有写操作命令。
    *   以追加的方式写入文件，当文件过大时会自动进行重写 (rewrite) 以压缩文件。
    *   优点：数据安全性更高，丢失数据量少。
    *   缺点：AOF 文件通常比 RDB 文件大，恢复速度相对较慢。

## 2. 备份策略

### 2.1. RDB 备份

RDB 备份是最常用的备份方式，因为它简单且恢复速度快。

**手动备份**:
您可以使用 `BGSAVE` 命令在后台生成 RDB 文件，而不会阻塞 Redis 服务器。

```
BGSAVE
```

生成的 `dump.rdb` 文件通常位于 `redis.conf` 中 `dir` 配置项指定的目录下。

**自动化备份**:
*   **定时任务**: 设置 `cron` 任务，定期执行 `BGSAVE` 命令，并将生成的 `dump.rdb` 文件复制到安全的存储位置（如 S3、NFS 共享、异地服务器）。
*   **脚本**: 编写脚本来执行备份、压缩和上传操作。

**示例 (Linux cron 任务)**:

```bash
# 每天凌晨 2 点执行 BGSAVE 并复制文件
0 2 * * * redis-cli BGSAVE && cp /path/to/redis/dump.rdb /path/to/backup/dump-$(date +\%Y\%m\%d\%H\%M).rdb
```

### 2.2. AOF 备份

AOF 文件本身就是一种持续的备份。

**手动备份**:
直接复制 AOF 文件 (`appendonly.aof`) 到安全位置。在复制之前，最好先执行 `BGREWRITEAOF` 命令来重写 AOF 文件，以减小文件大小。

```
BGREWRITEAOF
```

**自动化备份**:
*   定期复制 `appendonly.aof` 文件。
*   结合 `BGREWRITEAOF` 命令，在复制前进行重写。

### 2.3. 混合持久化 (Redis 4.0+)

Redis 4.0 引入了混合持久化模式，它结合了 RDB 和 AOF 的优点。在 AOF 重写时，会将重写开始时的数据以 RDB 格式写入 AOF 文件的开头，之后的所有命令以 AOF 格式追加。这使得 AOF 文件在启动时加载更快。

在 `redis.conf` 中启用：

```conf
aof-use-rdb-preamble yes
```

## 3. 恢复方法

### 3.1. 从 RDB 文件恢复

这是最简单的恢复方式。

1.  停止 Redis 服务器。
2.  将备份的 `dump.rdb` 文件复制到 Redis 配置的 `dir` 目录下。
3.  启动 Redis 服务器。Redis 会自动加载 `dump.rdb` 文件。

### 3.2. 从 AOF 文件恢复

1.  停止 Redis 服务器。
2.  将备份的 `appendonly.aof` 文件复制到 Redis 配置的 `dir` 目录下。
3.  启动 Redis 服务器。Redis 会自动加载 `appendonly.aof` 文件。

### 3.3. 从混合持久化文件恢复

与从 AOF 文件恢复类似，Redis 会自动识别并加载混合格式的 AOF 文件。

### 3.4. 灾难恢复注意事项

*   **异地备份**: 将备份文件存储在与生产环境不同的地理位置，以防数据中心级别的故障。
*   **定期测试恢复**: 定期在非生产环境中测试备份文件的恢复过程，确保备份的有效性。
*   **版本兼容性**: 确保用于恢复的 Redis 版本与生成备份文件的版本兼容。
*   **权限**: 确保 Redis 进程对备份文件和目录有正确的读写权限。
*   **监控**: 监控备份任务的执行状态和备份文件的完整性。